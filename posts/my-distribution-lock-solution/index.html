<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="基于 Redis 的分布式锁的实现方案" /><meta name="author" content="Gengxin Li" /><meta property="og:locale" content="en_US" /><meta name="description" content="  经过上次的调研(这篇blog),最终和 Leader 确定使用 Redis 来实现我们的分布式锁." /><meta property="og:description" content="  经过上次的调研(这篇blog),最终和 Leader 确定使用 Redis 来实现我们的分布式锁." /><link rel="canonical" href="/posts/my-distribution-lock-solution/" /><meta property="og:url" content="/posts/my-distribution-lock-solution/" /><meta property="og:site_name" content="Ligengxin’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-12-29T00:00:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="基于 Redis 的分布式锁的实现方案" /><meta name="twitter:site" content="@Ligengxin1" /><meta name="twitter:creator" content="@Gengxin Li" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Gengxin Li"},"description":"  经过上次的调研(这篇blog),最终和 Leader 确定使用 Redis 来实现我们的分布式锁.","url":"/posts/my-distribution-lock-solution/","@type":"BlogPosting","headline":"基于 Redis 的分布式锁的实现方案","dateModified":"2021-12-29T00:00:00+08:00","datePublished":"2021-12-29T00:00:00+08:00","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/my-distribution-lock-solution/"},"@context":"https://schema.org"}</script><title>基于 Redis 的分布式锁的实现方案 | Ligengxin's Blog</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-ZPEXTB9VTS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZPEXTB9VTS'); }); </script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZPEXTB9VTS"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-ZPEXTB9VTS'); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars3.githubusercontent.com/u/46650314?s=460&u=fe0b26243b450e677f5b3bc9c97c6c5c2d9a81a4&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ligengxin's Blog</a></div><div class="site-subtitle font-italic">Be a programmer Don't be a CRUDer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Ligengxin96" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Ligengxin1" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ligengxin96','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); toggle.setDark(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>基于 Redis 的分布式锁的实现方案</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>基于 Redis 的分布式锁的实现方案</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Dec 29, 2021, 12:00 AM +0800" > Dec 29, 2021 <i class="unloaded">2021-12-29T00:00:00+08:00</i> </span> by <span class="author"> Gengxin Li </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2409 words">13 min</span></div></div><div class="post-content"><p>  经过上次的调研(<a href="/posts/2021-12-07-distribution-lock-solution-inverstigate">这篇blog</a>),最终和 Leader 确定使用 Redis 来实现我们的分布式锁.</p><h3 id="实现思路">实现思路</h3><p>   首先, 我们的 redis 是集群(Cluster)模式,集群里面的 redis 机器都会有一个 backup. 然后当我们的微服务部署后,一般来说分布式锁的名字都是会带上一个数据库中表数据的 id 来保证唯一性,并且使用<code class="language-plaintext highlighter-rouge">{}</code>来包裹这个id. 这样在集群模式下 redis 在计算把这个 key 分配给那个节点的时候只会对<code class="language-plaintext highlighter-rouge">{}</code>包裹的部分进行计算,并不需要计算整个字符串.可以节约点性能. 举个例子, 我们的一个接口是购买一个商品, 首先我们需要检查库存避免超售.那么我们就需要在业务开始的时候去请求锁.</p><div class="language-ts highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="c1">// logger 是 winston loggger 对象</span>
<span class="c1">// POD_ID 是 K8S 中每个 pod 的唯一标识</span>
<span class="c1">// CONSUMER_NAME 是消费者的名字, 因为使用了 redis stream 来发生解锁的通知 而不是加锁失败然后重试, 这样也减轻 redis 的请求压力</span>
<span class="kd">const</span> <span class="nx">CONSUMER_NAME</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">POD_ID</span> <span class="p">?</span> <span class="s2">`</span><span class="p">${</span><span class="nx">appName</span><span class="p">}</span><span class="s2">-consumer-</span><span class="p">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">POD_ID</span><span class="p">}</span><span class="s2">`</span> <span class="p">:</span> <span class="s2">`</span><span class="p">${</span><span class="nx">appName</span><span class="p">}</span><span class="s2">-consumer`</span>
<span class="kd">const</span> <span class="nx">lockName</span> <span class="o">=</span> <span class="s2">`buy_{</span><span class="p">${</span><span class="nx">goodsId</span><span class="p">}</span><span class="s2">}`</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">redlock</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RedLock</span><span class="p">(</span><span class="nx">lockName</span><span class="p">,</span> <span class="dl">'</span><span class="s1">EX</span><span class="dl">'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">CONSUMER_NAME</span><span class="p">,</span> <span class="nx">logger</span><span class="p">);</span>

<span class="c1">// begin: get lock</span>
<span class="k">await</span> <span class="nx">redlock</span><span class="p">.</span><span class="nx">lock</span><span class="p">();</span>

<span class="c1">// then: do some thing</span>

<span class="c1">// end: release lock</span>
<span class="k">await</span> <span class="nx">redlock</span><span class="p">.</span><span class="nx">unlock</span><span class="p">();</span>
</pre></table></code></div></div><p>   redis 在集群模式下有一个 slot 的概念, redis cluster 模式可以保证分布在多个机器的相同的服务在向 redis 请求同一个 key 的时候能访问到同一个节点. 并且上面的这段代码中 <code class="language-plaintext highlighter-rouge">goodsId</code> 是一个变量, 所以在购买不同商品会有不同的锁. redis 面对不同的 id 的锁也会均衡的把请求分配到不同的节点上.</p><p>   接下来就是我们的分布式锁实现的具体代码了, <code class="language-plaintext highlighter-rouge">@comm/redis.ts</code> 文件中只是 redis 相关的配置, <code class="language-plaintext highlighter-rouge">RedLock.ts</code> 和 <code class="language-plaintext highlighter-rouge">LockManager.ts</code> 是实现分布式的两个文件, 其实理论上只需要 <code class="language-plaintext highlighter-rouge">RedLock.ts</code> 的相关代码就能实现这样的一个分布式锁. 但是我们还引入了 <code class="language-plaintext highlighter-rouge">LockManager.ts</code> 来实现本机服务队列的这样的功能.如果超过队列的最大限制,我们就拒绝请求.具体细节可以看下面的代码和细节.</p><div class="language-ts highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="c1">// @comm/redis.ts</span>
<span class="k">import</span> <span class="nx">ioredis</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">ioredis</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">isUseLocalServer</span> <span class="o">=</span> <span class="o">!!</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">IS_LOCAL_SERVER</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">config</span><span class="p">:</span> <span class="nx">ioredis</span><span class="p">.</span><span class="nx">RedisOptions</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">commandTimeout</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="na">connectTimeout</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
  <span class="na">db</span><span class="p">:</span> <span class="nx">isUseLocalServer</span> <span class="p">?</span> <span class="mi">0</span> <span class="p">:</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS_INDEX</span> <span class="o">??</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="kd">const</span> <span class="nx">uriSingle</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">REDIS</span> <span class="o">??</span> <span class="dl">'</span><span class="s1">redis://localhost:6379</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">uriCluster</span> <span class="o">=</span> <span class="p">[</span>
  <span class="dl">'</span><span class="s1">redis://redis-0.redis.kube-node-test.svc.cluster.local:6379</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">redis://redis-1.redis.kube-node-test.svc.cluster.local:6379</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">redis://redis-2.redis.kube-node-test.svc.cluster.local:6379</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">redis://redis-3.redis.kube-node-test.svc.cluster.local:6379</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">redis://redis-4.redis.kube-node-test.svc.cluster.local:6379</span><span class="dl">'</span><span class="p">,</span>
  <span class="dl">'</span><span class="s1">redis://redis-5.redis.kube-node-test.svc.cluster.local:6379</span><span class="dl">'</span><span class="p">,</span>
<span class="p">];</span>

<span class="kd">const</span> <span class="nx">redis</span> <span class="o">=</span> <span class="nx">isUseLocalServer</span> <span class="p">?</span> <span class="k">new</span> <span class="nx">ioredis</span><span class="p">(</span><span class="nx">uriSingle</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span> <span class="p">:</span> <span class="k">new</span> <span class="nx">ioredis</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="nx">uriCluster</span><span class="p">,</span> <span class="nx">config</span><span class="p">);</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">redis</span><span class="p">;</span>
</pre></table></code></div></div><div class="language-ts highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
</pre><td class="rouge-code"><pre><span class="c1">// RedLock.ts</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">nanoid</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">nanoid</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">redis</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@comm/redis</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Logger</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/utils/logger</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">LockManger</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./LockManager</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">type</span> <span class="nx">ExpireModel</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">EX</span><span class="dl">'</span> <span class="o">|</span> <span class="dl">'</span><span class="s1">PX</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">type</span> <span class="nx">ConText</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">resolve</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
  <span class="nl">reject</span><span class="p">:</span> <span class="p">(</span><span class="na">err</span><span class="p">:</span> <span class="nb">Error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">RedLock</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">context</span><span class="p">?:</span> <span class="nx">ConText</span><span class="p">;</span>
  <span class="k">private</span> <span class="nx">timeout</span><span class="p">?:</span> <span class="nx">NodeJS</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">;</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>                <span class="c1">// 锁的唯一id 只有知道这个 id 才可以解锁, 也就是只有自己能解锁, 避免被别的服务解锁</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">lockName</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>          <span class="c1">// 锁的名字</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">expireModel</span><span class="p">:</span> <span class="nx">ExpireModel</span>   <span class="c1">// 锁的过期模式 'EX' | 'PX'</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">ttl</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>               <span class="c1">// 锁的过期时间</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">consumerName</span><span class="p">;</span>              <span class="c1">// 消费者的名字 redis stream 中的一个消费者的概念</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">;</span>            <span class="c1">// winston logger</span>
  <span class="k">private</span> <span class="k">readonly</span> <span class="nx">maxWaitingLength</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>  <span class="c1">// 最大等待队列长度</span>

  <span class="kd">constructor</span><span class="p">(</span><span class="nx">lockName</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">expireModel</span><span class="p">:</span> <span class="nx">ExpireModel</span><span class="p">,</span> <span class="nx">ttl</span><span class="p">:</span> <span class="kr">number</span><span class="p">,</span> <span class="nx">consumerName</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">logger</span><span class="p">:</span> <span class="nx">Logger</span><span class="p">,</span> <span class="nx">maxWaitingLength</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">nanoid</span><span class="p">(</span><span class="mi">36</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ttl</span> <span class="o">=</span> <span class="nx">ttl</span><span class="p">;</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span> <span class="o">=</span> <span class="nx">logger</span><span class="p">;</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">lockName</span> <span class="o">=</span> <span class="nx">lockName</span><span class="p">;</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">expireModel</span> <span class="o">=</span> <span class="nx">expireModel</span><span class="p">;</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">consumerName</span> <span class="o">=</span> <span class="nx">consumerName</span><span class="p">;</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">maxWaitingLength</span> <span class="o">=</span> <span class="nx">maxWaitingLength</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">getId</span> <span class="o">=</span> <span class="p">():</span> <span class="kr">string</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
  <span class="nx">getTtl</span> <span class="o">=</span> <span class="p">():</span> <span class="kr">number</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">ttl</span><span class="p">;</span>
  <span class="nx">getLogger</span> <span class="o">=</span> <span class="p">():</span> <span class="nx">Logger</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">;</span>
  <span class="nx">getLockName</span> <span class="o">=</span> <span class="p">():</span> <span class="kr">string</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">;</span>
  <span class="nx">getConsumerName</span> <span class="o">=</span> <span class="p">():</span> <span class="kr">string</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">consumerName</span><span class="p">;</span>
  <span class="nx">getContext</span> <span class="o">=</span> <span class="p">():</span> <span class="nx">ConText</span> <span class="o">|</span> <span class="kc">undefined</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">;</span>
  <span class="nx">getExpireModel</span> <span class="o">=</span> <span class="p">():</span> <span class="nx">ExpireModel</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">expireModel</span><span class="p">;</span>
  <span class="nx">getMaxWaitingLength</span> <span class="o">=</span> <span class="p">():</span> <span class="kr">number</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxWaitingLength</span><span class="p">;</span>

  <span class="nx">onResume</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">?.</span><span class="nx">resolve</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">onError</span><span class="p">(</span><span class="nx">err</span><span class="p">:</span> <span class="nb">Error</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">?.</span><span class="nx">reject</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// 对外暴露的加锁的方法</span>
  <span class="k">async</span> <span class="nx">lock</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span> 
    <span class="kd">const</span> <span class="nx">lockList</span> <span class="o">=</span> <span class="nx">LockManger</span><span class="p">.</span><span class="nx">getLockListMap</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">lockList</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">);</span>
    <span class="c1">// 首先确保我们的等待队列不超过 maxWaitingLength 如果超过了,直接抛出服务正忙的异常</span>
    <span class="k">if</span> <span class="p">((</span><span class="nx">data</span><span class="p">?.</span><span class="nx">waiting</span><span class="p">?.</span><span class="nx">length</span> <span class="o">??</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxWaitingLength</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`lock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2"> waiting length is </span><span class="p">${</span><span class="nx">data</span><span class="p">?.</span><span class="nx">waiting</span><span class="p">?.</span><span class="nx">length</span><span class="p">}</span><span class="s2">, max waiting length is </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">maxWaitingLength</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="dl">'</span><span class="s1">Server is busy, please try again later</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// 判断当前请求前面是否有别的请求在等待, 如果有则 await. 等待 onResume() 方法被调用唤醒, onResume 方法会在 LockManager 的 execNext 方法中被调用</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">LockManger</span><span class="p">.</span><span class="nx">isQueueLocked</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`lock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2"> is locked.`</span><span class="p">);</span>
      <span class="k">await</span> <span class="k">new</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">resolve</span><span class="p">,</span>
          <span class="nx">reject</span><span class="p">,</span>
        <span class="p">};</span>
      <span class="p">});</span>
    <span class="p">}</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRedisLock</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 对外暴露解锁的方法</span>
  <span class="k">async</span> <span class="nx">unlock</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`clear timeout for lock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">, id: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">, timer: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="c1">// 解锁的时候清除定时器</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">timeout</span><span class="p">);</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">onRelease</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 在 redis 加锁的实际逻辑</span>
  <span class="k">private</span> <span class="k">async</span> <span class="nx">getRedisLock</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nx">LockManger</span><span class="p">.</span><span class="nx">setCurrentLock</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`Set current lock, lockName: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">, id: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">expireModel</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">ttl</span><span class="p">,</span> <span class="dl">'</span><span class="s1">NX</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`get redis lock return value: </span><span class="p">${</span><span class="nx">result</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">OK</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 加锁成功后设置一个定时器,如果没有调用 unlock() 方法, 则会在锁过期后自动触发 onTimeout() 方法自动解锁 </span>
      <span class="kd">const</span> <span class="nx">time</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">expireModel</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">PX</span><span class="dl">'</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">ttl</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">ttl</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onTimeout</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="nx">time</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 如果加锁失败, 则监听 redis stream 等待服务向 stream 发送解锁消息. 当收到解锁消息后再去请求锁</span>
      <span class="kd">const</span> <span class="nx">messages</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">xreadgroup</span><span class="p">(</span><span class="dl">'</span><span class="s1">GROUP</span><span class="dl">'</span><span class="p">,</span> <span class="nx">LockManger</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">consumerName</span><span class="p">,</span> <span class="dl">'</span><span class="s1">block</span><span class="dl">'</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="dl">'</span><span class="s1">STREAMS</span><span class="dl">'</span><span class="p">,</span> <span class="nx">LockManger</span><span class="p">.</span><span class="nx">streams</span><span class="p">,</span> <span class="dl">'</span><span class="s1">&gt;</span><span class="dl">'</span><span class="p">);</span>
      <span class="kd">const</span> <span class="p">[</span><span class="nx">_</span><span class="p">,</span> <span class="p">[[</span><span class="nx">key</span><span class="p">,</span> <span class="p">[</span><span class="nx">lockName</span><span class="p">,</span> <span class="nx">message</span><span class="p">]]]]</span> <span class="o">=</span> <span class="nx">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`consumerName </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">consumerName</span><span class="p">}</span><span class="s2">, listen unlock message, key: </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">, lockName: </span><span class="p">${</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">, message: </span><span class="p">${</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="c1">// 收到解锁消息,并 ack 这条消息, 表示这个消息已经被处理过了</span>
      <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">xack</span><span class="p">(</span><span class="nx">LockManger</span><span class="p">.</span><span class="nx">streams</span><span class="p">,</span> <span class="nx">LockManger</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span> <span class="nx">key</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`ack unlock message success, key: </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">, streams: </span><span class="p">${</span><span class="nx">LockManger</span><span class="p">.</span><span class="nx">streams</span><span class="p">}</span><span class="s2">, message: </span><span class="p">${</span><span class="nx">LockManger</span><span class="p">.</span><span class="nx">group</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">getRedisLock</span><span class="p">();</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 锁到了过期时间后被定时器调用释放锁 </span>
  <span class="k">private</span> <span class="k">async</span> <span class="nx">onTimeout</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`Lock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2"> id: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2"> is expired in </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">ttl</span><span class="p">}</span><span class="s2"> seconds`</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">timeout</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">await</span> <span class="k">this</span><span class="p">.</span><span class="nx">onRelease</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 执行 lua 脚本释放锁 并且发送一个 unlock 消息到 redis stream</span>
  <span class="c1">// 这里记录了很多 warn 日志, 因为可能会存在锁超时而业务代码还没有执行完的情况, 所以我们需要定期检查下这些高危日志, 这也是我们分布式锁的一个问题</span>
  <span class="c1">// 当然 如果我们也可以自动给锁续期, 虽然能解决这个问题,但是如果业务一直不结束, 那么我们的锁也就会有死锁问题. 所以最终我们选定的方案是给锁设置一个大大超过业务执行时间的一个过期时间</span>
  <span class="k">private</span> <span class="k">async</span> <span class="nx">onRelease</span><span class="p">():</span> <span class="nb">Promise</span><span class="o">&lt;</span><span class="k">void</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">script</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">if redis.call("get",KEYS[1]) == ARGV[1] then</span><span class="dl">'</span> <span class="o">+</span>
      <span class="dl">'</span><span class="s1">   return redis.call("del",KEYS[1]) </span><span class="dl">'</span> <span class="o">+</span>
      <span class="dl">'</span><span class="s1">else</span><span class="dl">'</span> <span class="o">+</span>
      <span class="dl">'</span><span class="s1">   return 0 </span><span class="dl">'</span> <span class="o">+</span>
      <span class="dl">'</span><span class="s1">end</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">result</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`unlock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">, id: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2"> success`</span><span class="p">);</span>
      <span class="c1">// 判断是否解锁消息发送成功,不成功则重试</span>
      <span class="kd">let</span> <span class="nx">isSendMessageSuccess</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="kd">let</span> <span class="nx">retryCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="k">do</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="kd">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">xadd</span><span class="p">(</span><span class="nx">LockManger</span><span class="p">.</span><span class="nx">streams</span><span class="p">,</span> <span class="dl">'</span><span class="s1">*</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">,</span> <span class="s2">`unlock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`send unlock message to </span><span class="p">${</span><span class="nx">LockManger</span><span class="p">.</span><span class="nx">streams</span><span class="p">}</span><span class="s2"> success, key: </span><span class="p">${</span><span class="nx">key</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
          <span class="nx">isSendMessageSuccess</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`xadd unlock message failed with error: </span><span class="p">${</span><span class="nx">error</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
          <span class="nx">retryCount</span><span class="o">++</span><span class="p">;</span>
          <span class="k">await</span> <span class="nx">Time</span><span class="p">.</span><span class="nx">waitForMs</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span> <span class="c1">// 不做任何操作 只是休眠 100ms</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSendMessageSuccess</span> <span class="o">&amp;&amp;</span> <span class="nx">retryCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">warn</span><span class="p">(</span><span class="s2">`unlock </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">, id: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">}</span><span class="s2"> failed, </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">lockName</span><span class="p">}</span><span class="s2"> maybe expired`</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="dl">'</span><span class="s1">begin exec next request</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">LockManger</span><span class="p">.</span><span class="nx">execNext</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">RedLock</span><span class="p">;</span>
</pre></table></code></div></div><div class="language-ts highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
</pre><td class="rouge-code"><pre><span class="c1">// LockManger.ts</span>
<span class="k">import</span> <span class="nx">redis</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@comm/redis</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Logger</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@/utils/logger</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">RedLock</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./RedLock</span><span class="dl">'</span><span class="p">;</span>

<span class="c1">// winston logger</span>
<span class="kd">const</span> <span class="nx">logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">(</span><span class="dl">'</span><span class="s1">LockManager</span><span class="dl">'</span><span class="p">);</span>

<span class="kr">interface</span> <span class="nx">RedLockQueue</span> <span class="p">{</span>
  <span class="nl">current</span><span class="p">:</span> <span class="nx">RedLock</span> <span class="o">|</span> <span class="kc">null</span><span class="p">;</span>
  <span class="nl">waiting</span><span class="p">:</span> <span class="nx">RedLock</span><span class="p">[];</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">LockManager</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">lockListmap</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">RedLockQueue</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">public</span> <span class="nx">streams</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">lockStream</span><span class="dl">'</span><span class="p">,</span> <span class="k">public</span> <span class="nx">group</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">lockStreamGroup</span><span class="dl">'</span><span class="p">)</span> <span class="p">{}</span>

  <span class="c1">// 服务启动的时候创建一个 redis stream 和消费组, 这个是原子操作, 多个微服务只会有一个创建成功</span>
  <span class="k">async</span> <span class="nx">initialize</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="k">await</span> <span class="nx">redis</span><span class="p">.</span><span class="nx">xgroup</span><span class="p">(</span><span class="dl">'</span><span class="s1">create</span><span class="dl">'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">group</span><span class="p">,</span> <span class="dl">'</span><span class="s1">$</span><span class="dl">'</span><span class="p">);</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`streams: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">}</span><span class="s2">, group: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">group</span><span class="p">}</span><span class="s2"> created successfully.`</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`streams: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">streams</span><span class="p">}</span><span class="s2">, group: </span><span class="p">${</span><span class="k">this</span><span class="p">.</span><span class="nx">group</span><span class="p">}</span><span class="s2"> created faile with error: </span><span class="p">${</span><span class="nx">error</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">getLockListMap</span> <span class="o">=</span> <span class="p">():</span> <span class="nb">Map</span><span class="o">&lt;</span><span class="kr">string</span><span class="p">,</span> <span class="nx">RedLockQueue</span><span class="o">&gt;</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockListmap</span><span class="p">;</span>

  <span class="nx">setCurrentLock</span><span class="p">(</span><span class="nx">lock</span><span class="p">:</span> <span class="nx">RedLock</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">lockName</span> <span class="o">=</span> <span class="nx">lock</span><span class="p">.</span><span class="nx">getLockName</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockListmap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">lock</span><span class="p">.</span><span class="nx">getLockName</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">lockListmap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">lockName</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">current</span><span class="p">:</span> <span class="nx">lock</span><span class="p">,</span>
        <span class="na">waiting</span><span class="p">:</span> <span class="p">[],</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">lock</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="c1">// 判断当时锁是否有需要等待的请求,有就排队</span>
  <span class="nx">isQueueLocked</span><span class="p">(</span><span class="nx">lock</span><span class="p">:</span> <span class="nx">RedLock</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">lockName</span> <span class="o">=</span> <span class="nx">lock</span><span class="p">.</span><span class="nx">getLockName</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockListmap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">lockName</span><span class="p">);</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`check lock queue, lockName: </span><span class="p">${</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">, current lockName: </span><span class="p">${</span><span class="nx">data</span><span class="p">?.</span><span class="nx">current</span><span class="p">?.</span><span class="nx">getLockName</span><span class="p">()}</span><span class="s2">, waiting length: </span><span class="p">${</span><span class="nx">data</span><span class="p">?.</span><span class="nx">waiting</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">?.</span><span class="nx">current</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pushWaitingQueue</span><span class="p">(</span><span class="nx">lock</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">execNext</span><span class="p">(</span><span class="nx">lock</span><span class="p">:</span> <span class="nx">RedLock</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">lock</span><span class="p">.</span><span class="nx">getId</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">lockName</span> <span class="o">=</span> <span class="nx">lock</span><span class="p">.</span><span class="nx">getLockName</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockListmap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">lockName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`cannot find </span><span class="p">${</span><span class="nx">lockName</span><span class="p">}</span><span class="s2"> in lockListmap`</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">const</span> <span class="nx">item</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">waiting</span><span class="p">.</span><span class="nx">pop</span><span class="p">();</span>
    <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`exec next request, next lock: </span><span class="p">${</span><span class="nx">item</span><span class="p">?.</span><span class="nx">getLockName</span><span class="p">()}</span><span class="s2">, waiting length: </span><span class="p">${</span><span class="nx">data</span><span class="p">.</span><span class="nx">waiting</span><span class="p">.</span><span class="nx">length</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">item</span><span class="p">.</span><span class="nx">onResume</span><span class="p">();</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="nx">item</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">current</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">logger</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">`waiting queue is empty, lockName: </span><span class="p">${</span><span class="nx">lockName</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="k">private</span> <span class="nx">pushWaitingQueue</span><span class="p">(</span><span class="nx">lock</span><span class="p">:</span> <span class="nx">RedLock</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">lock</span><span class="p">.</span><span class="nx">getLockName</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">lockName</span> <span class="o">=</span> <span class="nx">lock</span><span class="p">.</span><span class="nx">getLockName</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lockListmap</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">lockName</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">data</span><span class="p">.</span><span class="nx">waiting</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">lock</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">LockManger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LockManager</span><span class="p">();</span>
<span class="nx">LockManger</span><span class="p">.</span><span class="nx">initialize</span><span class="p">();</span>
<span class="k">export</span> <span class="k">default</span> <span class="nx">LockManger</span><span class="p">;</span>
</pre></table></code></div></div><p>   这份代码是第一版的实现方案,<code class="language-plaintext highlighter-rouge">RedLock</code>这个类的配置信息和构造参数目前来说还是太多了,有些细节还需要再调整下.比如说可以将<code class="language-plaintext highlighter-rouge">RedLock</code>这个类作为一个基类, 每个微服务根据业务的不同可以继承<code class="language-plaintext highlighter-rouge">RedLock</code>类然后把一些构造参数和配置固定, 然后在 <code class="language-plaintext highlighter-rouge">new RedLock</code> 的时候就可以简单一些了.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/technology/'>Technology</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/node-js/" class="post-tag no-text-decoration" >Node.js</a> <a href="/tags/redis/" class="post-tag no-text-decoration" >Redis</a> <a href="/tags/distributed-lock/" class="post-tag no-text-decoration" >Distributed Lock</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=基于 Redis 的分布式锁的实现方案 - Ligengxin's Blog&url=/posts/my-distribution-lock-solution/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=基于 Redis 的分布式锁的实现方案 - Ligengxin's Blog&u=/posts/my-distribution-lock-solution/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=基于 Redis 的分布式锁的实现方案 - Ligengxin's Blog&url=/posts/my-distribution-lock-solution/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/node-js/">Node.js</a> <a class="post-tag" href="/tags/react-js/">React.js</a> <a class="post-tag" href="/tags/sql-server/">SQL Server</a> <a class="post-tag" href="/tags/transact-sql/">Transact-SQL</a> <a class="post-tag" href="/tags/summary/">Summary</a> <a class="post-tag" href="/tags/ant-design/">Ant Design</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/distributed-lock/">Distributed Lock</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/dokcer/">Dokcer</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/distribution-lock-solution-inverstigate/"><div class="card-body"> <span class="timeago small" > Dec 7, 2021 <i class="unloaded">2021-12-07T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>分布式锁/分布式事务的研究报告</h3><div class="text-muted small"><p>   成功换了一个后端的工作,开始的第一个任务就是熟悉下分布式锁和分布式事务的实现方案,然后写一份调研报告,这里简单记录下. 1. 分布式锁/分布式事务概念 分布式锁 只要的应用场景是在集群模式的多个相同服务,可能会部署在不同机器上,解决进程间安全问题,防止多进程同时操作一个变量或者数据库.解决的是多进程的并发问题. 分布式事务 解决一个联动操作,比如一个商品的买卖分为: ...</p></div></div></a></div><div class="card"> <a href="/posts/node.js-event-loop/"><div class="card-body"> <span class="timeago small" > Jan 13 <i class="unloaded">2022-01-13T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>重新理解 Node.js 事件循环</h3><div class="text-muted small"><p>    以前我对于 Node.js 的事件循环只有一个模糊概念, 就是 Node.js 执行完毕同步任务后(我理解的同步任务是指,在当前调用栈中执行的代码,而异步任务是指在在当前调用栈中被放置在回调函数里面的代码), 如果同步任务有回调, 那么就丢到事件循环队列中去.同步任务执行完毕后再去执行队列中的回调. 但是最近总是在想一个问题, Node.js 的事件循环有一个问题, 既然是队列,那肯定...</p></div></div></a></div><div class="card"> <a href="/posts/mistake-of-promise-all/"><div class="card-body"> <span class="timeago small" > Feb 26 <i class="unloaded">2022-02-26T00:00:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>对于 Promise.all() 的误解</h3><div class="text-muted small"><p>    今天在做一个需求的时候 sequelize 抛出了这样的一个问题 Error: commit has been called on this transaction(724d4efa-4707-4931-bf7e-5172eb7e5b49), you can no longer use it. 后来分析发现自己原来一直对 Promise.all() 的使用有些误解.    简单讲下业...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/javascript-design-pattern/" class="btn btn-outline-primary"><p>Javascript 设计模式与开发实践总结</p></a> <a href="/posts/my-2021-summary/" class="btn btn-outline-primary"><p>我的2021年终总结</p></a></div><div id="gitalk-container"> <script> const gitalk = new Gitalk({ clientID: 'ef43f800a04cc65684b8', clientSecret: '60713915b72af48819c6e0389766198a7410ee48', repo: 'Blog', owner: 'Ligengxin96', admin: ['Ligengxin96'], id: location.pathname, distractionFreeMode: false }); gitalk.render('gitalk-container') </script></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/Ligengxin1">Gengxin Li</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/node-js/">Node.js</a> <a class="post-tag" href="/tags/react-js/">React.js</a> <a class="post-tag" href="/tags/sql-server/">SQL Server</a> <a class="post-tag" href="/tags/transact-sql/">Transact SQL</a> <a class="post-tag" href="/tags/summary/">Summary</a> <a class="post-tag" href="/tags/ant-design/">Ant Design</a> <a class="post-tag" href="/tags/azure/">Azure</a> <a class="post-tag" href="/tags/distributed-lock/">Distributed Lock</a> <a class="post-tag" href="/tags/docker/">Docker</a> <a class="post-tag" href="/tags/dokcer/">Dokcer</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
